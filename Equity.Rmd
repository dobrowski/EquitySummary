---
title: "Equity Summary"
author: "David Dobrowski"
date: "9/29/2021"
output:
  beamer_presentation: default
  powerpoint_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE , message=FALSE, warning = FALSE)

library(here)
library(rmarkdown)
library(knitr)
library(tidyverse)
library(glue)
library(readxl)
library(MCOE)
library(ggthemes)
library(googlesheets4)
library(scales)

options(scipen=999)


con <- MCOE::mcoe_sql_con()



sheet_id <- "https://docs.google.com/spreadsheets/d/1_EmvLQq-cUe8Ist_WYGJFgdjD27dajpfSbEd_djvbsc/edit#gid=0"

codebook <- read_sheet(sheet_id,
                       col_types = "ccccccD")


left_join_codebook <- function(df, tablename, field){

codebook.short <- codebook %>%
    filter(table == tablename,
           field_name == field) %>%
    select(variable,definition)

    left_join(df, codebook.short, by = setNames( "variable", field))
    
}


entit <- tbl(con, "SCHOOLS") %>%
    collect() %>%
    select(cds = CDSCode, District)


```




```{r staff-demo, fig.width=9}

staff_demo <- tbl(con, "STAFF_DEMO")  %>%
   filter( CountyName == "Monterey",
           AcademicYear == "1819"
 ) %>%
  collect()


staff_demo2 <- staff_demo %>%
    mutate(EthnicGroup = as.character(EthnicGroup)) %>%
    left_join_codebook("STAFF_DEMO", "EthnicGroup") %>%
    group_by(DistrictName, definition) %>%
    count() %>%
    group_by(DistrictName) %>%
    mutate(perc = n/sum(n)) 

staff.color <- staff_demo2 %>%
    filter( str_detect(definition, "White|Reported") ) %>%
    transmute(perc.color = 1-sum(perc)) %>%
    distinct()
```


## Teacher Demographics - Countywide


``` {r staff-county}

staff_demo2 %>% 
    group_by(definition) %>%
   summarise(total =  sum(n) ) %>%
    mutate(Percent = total/sum(total)) %>%



ggplot( aes(x = reorder(definition, total ),
            y = total,
            label = percent(Percent, accuracy = 0.1),
            fill = definition)) +
    geom_col() +
    coord_flip() + 
    geom_label( size = 3,
                show.legend = FALSE)+
        mcoe_theme +
    scale_fill_brewer(palette = "Set1") +
        guides(fill = guide_legend(label.position = "bottom",
                               nrow = 3,
                               keywidth = 10,
                               label.vjust = 10)) 




```

## Teacher Demographics - By District


``` {r staff-district}
staff_demo2 %>%
    left_join(staff.color) %>%
ggplot( aes(x = reorder(DistrictName,perc.color) ,
            y = n,
            fill = definition            )
        )+ 
    geom_col() + 
    geom_text(data = staff_demo2 %>%
                  left_join(staff.color) %>%
                  group_by(DistrictName) %>%
                  slice(1),
              size = 3.5,
             # position =  position_stack(10),
              aes (label = percent( perc.color, accuracy = 0.1),
                   y = -50)) +
    mcoe_theme +
    scale_fill_brewer(palette = "Set1") +
    coord_flip() +
    guides(fill = guide_legend(label.position = "bottom",
                               nrow = 3,
                               keywidth = 10,
                               label.vjust = 10)) +
    labs(title = "Number of Certified Staff by District by Race/Ethnicity",
         subtitle = "Including percent of teachers of color")

```



## Student Demographics - Countywide

```{r enrollment, fig.width=9}

enrollment <- tbl(con, "ENROLLMENT")  %>%
 #   head() %>%
   filter( County == "Monterey",
 ) %>%
  collect()


enrollment.sum <- enrollment %>%
    filter(YEAR == max(YEAR)) %>%
    group_by(DISTRICT, ETHNIC) %>%
    summarise(TOTAL = sum(ENR_TOTAL)) %>%
    mutate(ETHNIC = as.character(ETHNIC),
           Percent = TOTAL/sum(TOTAL)) %>%
    left_join_codebook("ENROLLMENT", "ETHNIC" )

county.sum <- enrollment.sum %>%
    group_by(ETHNIC) %>% 
    summarise(GRAND.TOTAL = sum(TOTAL)) %>%
    mutate(Percent = GRAND.TOTAL/sum(GRAND.TOTAL))%>%
    left_join_codebook("ENROLLMENT", "ETHNIC" )

ggplot(county.sum, aes(x = reorder(definition, GRAND.TOTAL ), y = GRAND.TOTAL, label = percent(Percent, accuracy = 0.1))) +
    geom_col() +
    coord_flip() + 
    geom_label(
                   size = 2,
                   show.legend = FALSE) +
    mcoe_theme


```

## Student Demographics - By district

Number and percent of African-American students
```{r black-demo}
enrollment.sum %>%
    filter(ETHNIC == 6) %>%
    ggplot( aes(x = reorder(DISTRICT, TOTAL ),
                y = TOTAL,
                label = paste0(TOTAL,", ", percent(Percent, accuracy = 0.1) )
                ))  +
    geom_col(fill = "lightblue") +
    coord_flip() + 
    geom_label(
                   size = 2,
                   show.legend = FALSE) +
    mcoe_theme 

```


## Student Demographics - By district

Number and percent of Latinx students
```{r latinx-demo}
enrollment.sum %>%
    filter(ETHNIC == 5) %>%
    ggplot( aes(x = reorder(DISTRICT, TOTAL ),
                y = TOTAL,
                label = paste0(TOTAL,", ", percent(Percent, accuracy = 0.1) )
                ))  +
    geom_col(fill = "lightgreen") +
    coord_flip() + 
    geom_label(
                   size = 2,
                   show.legend = FALSE) +
    mcoe_theme 

```



## Performance Data from Dashboard



## Suspensions

```{r susp}


susp_vroom <- tbl(con,"SUSP") %>% 
  filter(county_code == 27,
          charter_yn == "All" | is.na(charter_yn) | charter_yn == "") %>%
  collect() %>%
  mutate(Geo = if_else(aggregate_level == "T", "California" ,county_name ))# %>%
#  mutate_at(vars(cumulative_enrollment:suspension_count_other_reasons), funs(as.numeric) )

susp_all <- susp_vroom %>%
  filter( (aggregate_level == "T"  |county_code == 27),
          reporting_category == "TA") 



susp_sub <- susp_vroom %>%  
  filter( is.na(district_code),
    (county_code == 27),
    academic_year == max(academic_year)
 ) %>%
  left_join_codebook("SUSP","reporting_category") %>%
    rename(ReportingCategory = reporting_category)# %>%
#  left_join(susp.acron) %>%
  # mutate(StudentGroupCategory = str_extract(ReportingCategory ,"[:alpha:]{1,1}"  )) %>%
  # mutate(StudentGroupCategory = case_when(StudentGroupCategory == "G" ~ "Gender",
  #                                         StudentGroupCategory == "R" ~ "Race/Ethnicity",
  #                                         StudentGroupCategory == "S" ~ "Student Group")) %>%
  # filter(ReportingCategory == "TA"| str_sub(ReportingCategory,1,1) == "R")
  


ggplot(susp_sub, aes( y = suspension_rate_total/100, x =fct_reorder(definition, suspension_rate_total) ,  label = percent(suspension_rate_total/100, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder(definition, suspension_rate_total), xend=fct_reorder(definition, suspension_rate_total), y=0, yend=suspension_rate_total/100),
                color="orange",
                size =2 ) +
  geom_point( color="orange", size=5, alpha=0.6) +
#  facet_grid(facets = vars(StudentGroupCategory), scales = "free" ) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_hc() +
  mcoe_theme +
  labs(title = ("K-12 Suspension Rates By Subgroup"), # fn("K-12 Suspension Rates Over Time"),
       caption = "Source: Suspension Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp")


```


## 

```{r susp-district}

susp_vroom %>%  
  filter( aggregate_level %in% c("C","D"),
    academic_year == max(academic_year),
    reporting_category == "RB",
    !is.na(suspension_rate_total)
 ) %>%
  left_join_codebook("SUSP","reporting_category") %>%
    rename(ReportingCategory = reporting_category) %>%
 mutate(cds = paste0(county_code,district_code,school_code)) %>%
    left_join(entit) %>%
    mutate(District = if_else(is.na(District),"Monterey County",District)) %>%


ggplot( aes( y = suspension_rate_total/100, x =fct_reorder(District, suspension_rate_total) ,  label = percent(suspension_rate_total/100, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder(District, suspension_rate_total), xend=fct_reorder(District, suspension_rate_total), y=0, yend=suspension_rate_total/100),
                color="lightblue",
                size =2 ) +
  geom_point( color="lightblue", size=5, alpha=0.6) +
#  facet_grid(facets = vars(StudentGroupCategory), scales = "free" ) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_hc() +
  mcoe_theme +
  labs(title = ("K-12 Suspension Rates By District for African-Americans"), # fn("K-12 Suspension Rates Over Time"),
       caption = "Source: Suspension Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp")


```


## 

```{r susp-county}

susp_vroom %>%  
  filter( aggregate_level %in% c("C","D"),
    academic_year == max(academic_year),
    reporting_category == "RH",
    !is.na(suspension_rate_total)
 ) %>%
  left_join_codebook("SUSP","reporting_category") %>%
    rename(ReportingCategory = reporting_category) %>%
 mutate(cds = paste0(county_code,district_code,school_code)) %>%
    left_join(entit) %>%
    mutate(District = if_else(is.na(District),"Monterey County",District)) %>%


ggplot( aes( y = suspension_rate_total/100, x =fct_reorder(District, suspension_rate_total) ,  label = percent(suspension_rate_total/100, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder(District, suspension_rate_total), xend=fct_reorder(District, suspension_rate_total), y=0, yend=suspension_rate_total/100),
                color="lightgreen",
                size =2 ) +
  geom_point( color="lightgreen", size=5, alpha=0.6) +
#  facet_grid(facets = vars(StudentGroupCategory), scales = "free" ) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_hc() +
  mcoe_theme +
  labs(title = ("K-12 Suspension Rates By District for Latinxs"), # fn("K-12 Suspension Rates Over Time"),
       caption = "Source: Suspension Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp")


```





## ELA 

```{r math}

# Generated from the CAASPP repo

sbac.all <- tbl(con,"CAASPP") %>% 
    filter(
        Test_Year == "2019",
        Grade == "13",
        County_Code == 27,
        School_Code == "0000000",
        Subgroup_ID == 1 | Subgroup_ID >70 & Subgroup_ID <81
    ) %>% 
#    head(50) %>%
    collect()

codebook.caaspp <- sbac.all %>%
    mutate(Subgroup_ID = as.character(Subgroup_ID)) %>%
    left_join_codebook("CAASPP","Subgroup_ID") %>%
    mutate(Percentage_Standard_Met_and_Above = as.numeric(Percentage_Standard_Met_and_Above),
           cds = paste0(County_Code,District_Code,School_Code)) %>%
    left_join(entit) %>%
    mutate(District = if_else(is.na(District),"Monterey County",District))





lollipop <- function(df, y_var, x_var, colorme) {
  ggplot(df, aes( y = {{y_var}}/100, x =fct_reorder({{x_var}}, {{y_var}}) ,  label = percent({{y_var}}/100, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder({{x_var}}, {{y_var}}/100), xend=fct_reorder({{x_var}}, {{y_var}}/100), y=0, yend={{y_var}}/100),
                color=colorme,
                size =2 ) +
  geom_point( color=colorme, size=5, alpha=0.6) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#  facet_grid(facets = vars(`Student Group`), scales = "free" ) +
  theme_hc() +
  mcoe_theme
}


caaspp_lollipop <- function(testy, district, students, df) {
    
    if (testy == 2) {test <- "Math"} else {test <- "ELA"}
    
   colorful <- case_when(district == FALSE ~ "orange",
          district == TRUE & students == 74 ~ "lightblue",
          district == TRUE & students == 78 ~ "lightgreen" )
    
    df %>%
        filter(Test_Id == testy) %>%
        filter(case_when(district == FALSE ~ District_Code == "00000",
                         district == TRUE ~ Subgroup_ID == students)) %>%
        filter(!is.na(Percentage_Standard_Met_and_Above)) %>%
    lollipop(y_var = Percentage_Standard_Met_and_Above,
             x_var = case_when(district == FALSE ~ definition,
                         district == TRUE ~ District),
             colorful) +
  labs(title = (paste0(test, " Percentage Meeting and Exceeding Rates ",   case_when(district == FALSE ~ "Countywide by Racial Group",
          district == TRUE & students == 74 ~ "by District for African-Americans",
          district == TRUE & students == 78 ~ "by District for Latinxs" )
                       )),
       caption = "Source: CAASPP 2019 Research Files \n https://caaspp-elpac.cde.ca.gov/caaspp/ResearchFileList")
    
}

caaspp_lollipop(df = codebook.caaspp,
                students = 74,
                testy = 1,
                district = FALSE
)





```

##

```{r ela-latinx}

caaspp_lollipop(df = codebook.caaspp,
                students = 74,
                testy = 1,
                district = TRUE
)



```


##

```{r ela-black}

caaspp_lollipop(df = codebook.caaspp,
                students = 78,
                testy = 1,
                district = TRUE
)



```


## Math

```{r math-county}

caaspp_lollipop(df = codebook.caaspp,
                students = 74,
                testy = 2,
                district = FALSE
)



```


##

```{r math-latinx}

caaspp_lollipop(df = codebook.caaspp,
                students = 74,
                testy = 2,
                district = TRUE
)



```


##

```{r math-black}

caaspp_lollipop(df = codebook.caaspp,
                students = 78,
                testy = 2,
                district = TRUE
)



```




## College Going Rate - Countywide


```{r cgr}


cgr_all <- tbl(con, "CGR")  %>%
  filter( # AggregateLevel %in% c("T", "C"),
          CountyCode %in% c("27"), 
#          CountyCode %in% c("27","00"), 
#          ReportingCategory == "TA",
          CharterSchool =="All",
          AlternativeSchoolAccountabilityStatus == "All",
          CompleterType =="TA"
) %>%
  collect() %>%
  mutate(Geo = if_else(AggregateLevel == "T", "California" , CountyName)) %>%
  mutate(CGR12 = College_Going_Rate_Total_12_Months,
         CGR12 = as.numeric(CGR12),
         DistrictName = if_else(is.na(DistrictName),"Monterey County",DistrictName)) %>%
    filter(ReportingCategory == "TA" | str_sub(ReportingCategory,1,1) == "R" ) %>%
    left_join_codebook("CGR","ReportingCategory") 

cgr_all %>% 
    filter(AcademicYear == max(AcademicYear),
           AggregateLevel %in% c("T", "C")) %>%
lollipop(
         y_var = CGR12,
         x_var = definition,
         colorme = "orange") +
  labs(title = ("College-Going Rate"),
       caption = "Source: College-Going Rate for HS Completers (12-month) \n  https://www.cde.ca.gov/ds/sd/sd/filescgr12.asp") 




```



## College Going Rate - By District


```{r cgr-black}

cgr_all %>% 
    filter(AcademicYear == max(AcademicYear),
           AggregateLevel %in% c("C", "D"),
           ReportingCategory == "RB",
           !is.na(CGR12)) %>%
lollipop(
         y_var = CGR12,
         x_var = DistrictName,
         colorme = "lightblue") +
  labs(title = ("College-Going Rate by District for African-Americans "),
       caption = "Source: College-Going Rate for HS Completers (12-month) \n  https://www.cde.ca.gov/ds/sd/sd/filescgr12.asp") 


```


## College Going Rate - By District


```{r cgr-latinx}

cgr_all %>% 
    filter(AcademicYear == max(AcademicYear),
           AggregateLevel %in% c("C", "D"),
           ReportingCategory == "RH",
           !is.na(CGR12)) %>%
lollipop(
         y_var = CGR12,
         x_var = DistrictName,
         colorme = "lightgreen") +
  labs(title = ("College-Going Rate by District for Latinxs "),
       caption = "Source: College-Going Rate for HS Completers (12-month) \n  https://www.cde.ca.gov/ds/sd/sd/filescgr12.asp") 


```

## Interaction College Data

https://public.tableau.com/app/profile/tulare.county.office.of.education/viz/CaliforniaPostsecondaryDataExplorer/Menu

## MCOE Efforts

- African-American Leadership Council
- ALL IN for Equity
- National Equity Project
- etc. 

## Clubs and Progams 


