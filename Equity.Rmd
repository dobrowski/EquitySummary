---
title: "Equity Review in regards to African-American and Latinx Students"
author: "MCOE"
date: "Compiled on `r format(Sys.Date(), '%B %d, %Y ' )`"
output:
  beamer_presentation: default
  slidy_presentation: default
  ioslides_presentation: default
  powerpoint_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE , message=FALSE, warning = FALSE)

library(here)
library(rmarkdown)
library(knitr)
library(tidyverse)
library(glue)
library(readxl)
library(MCOE)
library(ggthemes)
library(googlesheets4)
library(scales)
library(ggtext)
library(tidycensus)

options(scipen=999)


con <- MCOE::mcoe_sql_con()



sheet_id <- "https://docs.google.com/spreadsheets/d/1_EmvLQq-cUe8Ist_WYGJFgdjD27dajpfSbEd_djvbsc/edit#gid=0"

codebook <- read_sheet(sheet_id,
                       col_types = "ccccccD")


left_join_codebook <- function(df, tablename, field){

codebook.short <- codebook %>%
    filter(table == tablename,
           field_name == field) %>%
    select(variable,definition)

    left_join(df, codebook.short, by = setNames( "variable", field))
    
}


entit <- tbl(con, "SCHOOLS") %>%
    collect() %>%
    select(cds = CDSCode, District)



lollipop <- function(df, y_var, x_var, colorme) {
  ggplot(df, aes( y = {{y_var}}/100, x =fct_reorder({{x_var}}, {{y_var}}) ,  label = percent({{y_var}}/100, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder({{x_var}}, {{y_var}}/100), xend=fct_reorder({{x_var}}, {{y_var}}/100), y=0, yend={{y_var}}/100),
                color=colorme,
                size =2 ) +
  geom_point( color=colorme, size=5, alpha=0.6) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#  facet_grid(facets = vars(`Student Group`), scales = "free" ) +
  theme_hc() +
  mcoe_theme
}




```




```{r staff-demo, fig.width=9}

staff_demo <- tbl(con, "STAFF_DEMO")  %>%
   filter( CountyName == "Monterey",
           AcademicYear == "1819"
 ) %>%
  collect()


staff_demo2 <- staff_demo %>%
    mutate(EthnicGroup = as.character(EthnicGroup)) %>%
    left_join_codebook("STAFF_DEMO", "EthnicGroup") %>%
    group_by(DistrictName, definition) %>%
    count() %>%
    group_by(DistrictName) %>%
    mutate(perc = n/sum(n)) 

staff.color <- staff_demo2 %>%
    filter( str_detect(definition, "White|Reported") ) %>%
    transmute(perc.color = 1-sum(perc)) %>%
    distinct()
```


## Certified Staff Demographics - Countywide


``` {r staff-county, fig.width=9}

staff_demo2 %>% 
    group_by(definition) %>%
   summarise(total =  sum(n) ) %>%
    mutate(Percent = total/sum(total)) %>%



ggplot( aes(x = reorder(definition, total ),
            y = total,
            label = percent(Percent, accuracy = 0.1),
            fill = definition)) +
    geom_col() +
    coord_flip() + 
    geom_text( size = 3,show.legend = FALSE)+
        mcoe_theme +
    scale_fill_brewer(palette = "Paired") +
    theme(legend.position = "none") +
        # guides(fill = guide_legend(label.position = "bottom",
        #                        nrow = 3,
        #                        keywidth = 10,
        #                        label.vjust = 10)) +
    labs(caption = "Source: Staff Demographic 2018-19 Data Files\nhttps://www.cde.ca.gov/ds/ad/staffdemo.asp") +
  geom_textbox(x = 3, y = 1500, fill = "lightgrey",
               label = "The majority of certified staff in Monterey County are White.  A quarter of certified staff are Latino and less then two percent are African American.")




```

The majority of certified staff in Monterey County are White.  A quarter of certified staff are Latino and less then two percent are African American. 


## Certified Staff Demographics - By District


``` {r staff-district , fig.width=9}
staff_demo2 %>%
    left_join(staff.color) %>%
ggplot( aes(x = reorder(DistrictName,perc.color) ,
            y = n,
            fill = definition            )
        )+ 
    geom_col() + 
    geom_text(data = staff_demo2 %>%
                  left_join(staff.color) %>%
                  group_by(DistrictName) %>%
                  slice(1),
              size = 3.5,
             # position =  position_stack(10),
              aes (label = percent( perc.color, accuracy = 0.1),
                   y = -50)) +
    mcoe_theme +
    scale_fill_brewer(palette = "Paired") +
    coord_flip() +
    guides(fill = guide_legend(label.position = "bottom",
                               nrow = 3,
                               keywidth = 3,
                               label.vjust = 10
                               )) +
    labs(#title = "Number of Certified Staff by District by Race/Ethnicity",
         subtitle = "Sorted by percent of teachers of color" ,
         caption = "Source: Staff Demographic 2018-19 Data Files\n https://www.cde.ca.gov/ds/ad/staffdemo.asp") +
  geom_textbox(x = 20, y = 700, fill = "lightgrey",
               label = "The percent of teachers of color varies from three quarters to none of the certified staff.")


```



## Student Demographics - Countywide

```{r enrollment, fig.width=9}

enrollment <- tbl(con, "ENROLLMENT")  %>%
 #   head() %>%
   filter( County == "Monterey",
 ) %>%
  collect()


enrollment.sum <- enrollment %>%
    filter(YEAR == max(YEAR)) %>%
    group_by(DISTRICT, ETHNIC) %>%
    summarise(TOTAL = sum(ENR_TOTAL)) %>%
    mutate(ETHNIC = as.character(ETHNIC),
           Percent = TOTAL/sum(TOTAL)) %>%
    left_join_codebook("ENROLLMENT", "ETHNIC" )

county.sum <- enrollment.sum %>%
    group_by(ETHNIC) %>% 
    summarise(GRAND.TOTAL = sum(TOTAL)) %>%
    mutate(Percent = GRAND.TOTAL/sum(GRAND.TOTAL))%>%
    left_join_codebook("ENROLLMENT", "ETHNIC" )

ggplot(county.sum, aes(x = reorder(definition, GRAND.TOTAL ),
                       y = GRAND.TOTAL,
                       label = percent(Percent, accuracy = 0.1),
                       fill = definition 
                       )) +
    geom_col() +
    mcoe_theme +
        scale_fill_brewer(palette = "Paired") +
coord_flip() + 
    geom_text(size = 3, show.legend = FALSE) +
        guides(fill = guide_legend(label.position = "bottom",
                               nrow = 3,
                               keywidth = 10,
                               label.vjust = 10)) +
    labs(caption = "Source: Census Day Enrollment 2020-21 Data Files\nhttps://www.cde.ca.gov/ds/ad/filesenr.asp") +
  geom_textbox(x = 5, y = 50000, fill = "lightgrey",
               label = "In contrast to the certified staff, the large majority of students are Hispanic or Latino. Latinxs represent four out of five students in Monterey County. Less than two percent of students are African-American.")
    


```

## Student Demographics - By district

Number and percent of African-American students
```{r black-demo}
enrollment.sum %>%
    filter(ETHNIC == 6) %>%
    ggplot( aes(x = reorder(DISTRICT, TOTAL ),
                y = TOTAL,
                label = paste0(TOTAL," -- ", percent(Percent, accuracy = 0.1) )
                ))  +
    geom_col(fill = "lightblue") +
    coord_flip() + 
    geom_text(size = 3, show.legend = FALSE, y = 100) +
    mcoe_theme +    labs(caption = "Source: Census Day Enrollment 2020-21 Data Files\nhttps://www.cde.ca.gov/ds/ad/filesenr.asp") +
  geom_textbox(x = 8, y = 400, fill = "lightgrey",
               label = "MPUSD and SUHSD have the most African-American students.  While in MPUSD, PGUSD and Bradley, African-Americans represent the largest percentage of the student body relatively.")


```


## Student Demographics - By district

Number and percent of Latinx students
```{r latinx-demo}
enrollment.sum %>%
    filter(ETHNIC == 5) %>%
    ggplot( aes(x = reorder(DISTRICT, TOTAL ),
                y = TOTAL,
                label = paste0(comma(TOTAL, accuracy = 1)," -- ", percent(Percent, accuracy = 0.1) )
                ))  +
    geom_col(fill = "lightgreen") +
    coord_flip() + 
    geom_text(size = 3, show.legend = FALSE, y = 4000) +
    mcoe_theme +    
    labs(caption = "Source: Census Day Enrollment 2020-21 Data Files\nhttps://www.cde.ca.gov/ds/ad/filesenr.asp") +
  geom_textbox(x = 9, y = 10000, fill = "lightgrey",
               label = "SUHSD, SCESD and AUSD have the most Latinx students.  In more than half of the districts Latinx students represent more than 89 percent of the student body.")


```

## Student Demographics - Alternative Schools 

``` {r alt-schools}

not.report <- tibble("ETHNIC" = "8",
                 "GRAND.TOTAL" = 0,
                 "Percent" = 0,
                 "definition" = "Not Reported")


alt.schools <- tbl(con, "SCHOOLS") %>%
  filter(County == "Monterey",
         StatusType == "Active") %>%
    collect() %>%
  filter(EdOpsCode %in% c("ALTSOC","COMM","COMMDAY","CON"))

enroll.alt <- enrollment %>%
  filter(CDS_CODE %in% alt.schools$CDSCode) %>%
    filter(YEAR == max(YEAR)) %>%
    group_by(DISTRICT, ETHNIC) %>%
    summarise(TOTAL = sum(ENR_TOTAL)) %>%
    mutate(ETHNIC = as.character(ETHNIC),
           Percent = TOTAL/sum(TOTAL)) %>%
    left_join_codebook("ENROLLMENT", "ETHNIC" )

county.sum.alt <- enroll.alt %>%
    group_by(ETHNIC) %>% 
    summarise(GRAND.TOTAL = sum(TOTAL)) %>%
    mutate(Percent = GRAND.TOTAL/sum(GRAND.TOTAL))%>%
    left_join_codebook("ENROLLMENT", "ETHNIC" ) %>%
  bind_rows(not.report)



ggplot(county.sum.alt, aes(x = reorder(definition, GRAND.TOTAL ),
                       y = GRAND.TOTAL,
                       label = percent(Percent, accuracy = 0.1),
                       fill = definition 
                       )) +
    geom_col() +
    mcoe_theme +
        scale_fill_brewer(palette = "Paired") +
coord_flip() + 
    geom_text(size = 3, show.legend = FALSE) +
        guides(fill = guide_legend(label.position = "bottom",
                               nrow = 3,
                               keywidth = 10,
                               label.vjust = 10)) +
    labs(caption = "Source: Census Day Enrollment 2020-21 Data Files\nhttps://www.cde.ca.gov/ds/ad/filesenr.asp") +
  geom_textbox(x = 5, y = 500, fill = "lightgrey",
               label = "Students are enrolled in Alternative Schools of Choice, Community Day Schools, County Community Schools, and Continuation Schools at very similar percentages as the overall student body.")
    

```

## Census Data

``` {r census}

# age10 <- get_decennial(geography = "state", 
#                        variables = "P013001", 
#                        year = 2020)

census <- data.frame(
  stringsAsFactors = TRUE,
              race = c("African American or Black alone","American Indian and Alaska Native alone","Asian alone",
                       
                       "Hispanic or Latino",
                       "Pacific Islander and Native Hawaiian alone","Two or More Races",
                       "White alone, not Hispanic or Latino", "Filipino", "Not Reported"),
           percent = c(3.4,2.6,6.7,
                       59.4,0.6,3.8,29.4,NA,NA)
) %>% 
  mutate(race = fct_inorder(race))



ggplot(census, aes(x = reorder(race, percent ),
                       y = percent/100,
                       label = percent(percent/100, accuracy = 0.1),
                       fill = race 
                       )) +
    geom_col() +
    mcoe_theme +
        scale_fill_brewer(palette = "Paired") +
coord_flip() + 
    geom_text(size = 3, show.legend = FALSE) +
        guides(fill = guide_legend(label.position = "bottom",
                               nrow = 3,
                               keywidth = 10,
                               label.vjust = 10)) +
    labs(title = "Monterey County Total Population by Race",
         caption = "Source: US Census QuickFacts\nhttps://www.census.gov/quickfacts/fact/table/montereycountycalifornia,US/PST045219?") +
  geom_textbox(x = 5, y = 500, fill = "lightgrey",
               label = "Students are enrolled in Alternative Schools of Choice, Community Day Schools, County Community Schools, and Continuation Schools at very similar percentages as the overall student body.")


```

## Notes on Data

- All figures have a citation in the bottom right with the url to the public data source provided by California Department of Education where the data is found as well as identifying what year the data represents. 
- The most recent publicly available data is used. 
- Different data sources identify racial groups differently.  The axis labels use the terms used in that data source.  
- Graphs with a vertical list of numbers represent the size of the total group from which the percentage for that bar is derived.  

## Suspensions

```{r susp}


susp_vroom <- tbl(con,"SUSP") %>% 
  filter(county_code == 27,
          charter_yn == "All" | is.na(charter_yn) | charter_yn == "") %>%
  collect() %>%
  mutate(Geo = if_else(aggregate_level == "T", "California" ,county_name ))# %>%
#  mutate_at(vars(cumulative_enrollment:suspension_count_other_reasons), funs(as.numeric) )

susp_all <- susp_vroom %>%
  filter( (aggregate_level == "T"  |county_code == 27),
          reporting_category == "TA") 



susp_sub <- susp_vroom %>%  
  filter( is.na(district_code),
    (county_code == 27),
    academic_year == max(academic_year),
    !is.na(suspension_rate_total),
    str_sub(reporting_category,1,1) == "R"
 ) %>%
  left_join_codebook("SUSP","reporting_category") %>%
    rename(ReportingCategory = reporting_category)# %>%



susp_sub %>%
      lollipop(y_var = suspension_rate_total,
             x_var = definition,
             colorme = "orange") +
                geom_richtext(size = 3,
              aes (label =  glue("*{comma(unduplicated_count_of_students_suspended_total, accuracy = 1) } of {comma(cumulative_enrollment, accuracy = 1) }*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.002) +

  labs(title = ("Percentage of Students Suspended By Racial Group"), # fn("K-12 Suspension Rates Over Time"),
       caption = "Source: Suspension 2019-20 Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp") +
  geom_textbox(x = 4, y = .035, fill = "lightgrey",
               label = "African-Americans are suspended at a much higher rate than students in other racial groups.")


```


## 


```{r susp-racial}

susp_sub %>%
  mutate(count_susp = sum(unduplicated_count_of_students_suspended_total),
         race_perc = unduplicated_count_of_students_suspended_total/count_susp) %>%
        # lollipop(y_var = race_perc,
        #      x_var = definition,
        #      colorme = "orange")

ggplot( aes(x = reorder(definition, race_perc ),
                       y = race_perc,
                       label = percent(race_perc, accuracy = 0.1),
                       fill = definition 
                       )) +
    geom_col() +
    mcoe_theme +
        scale_fill_brewer(palette = "Paired") +
coord_flip() + 
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +

    geom_text(size = 3, show.legend = FALSE) +
        guides(fill = guide_legend(label.position = "bottom",
                               nrow = 3,
                               keywidth = 10,
                               label.vjust = 10)) +

  labs(title = ("Of Students Suspended, Percentage from each Racial Group"), 
       caption = "Source: Suspension 2019-20 Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp") +
  geom_textbox(x = 4, y = .5, fill = "lightgrey",
               label = "Latinx and African-American students represent a greater portion of students who are suspended than the total student population.")


```


## 


```{r susp-multiple}

susp_sub %>%
  mutate(repeat.rate = total_suspensions/unduplicated_count_of_students_suspended_total) %>%
ggplot( aes( y = repeat.rate, x =fct_reorder(definition, repeat.rate) ,  label = comma(repeat.rate, accuracy = .01))) +
  geom_segment( aes(x=fct_reorder(definition, repeat.rate), xend=fct_reorder(definition, repeat.rate), y=0, yend=repeat.rate),
                color="orange",
                size =2 ) +
  geom_point( color="orange", size=5, alpha=0.6) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous(labels = scales::comma_format(accuracy = .1)) +
  theme_hc() +
  mcoe_theme +
                geom_richtext(size = 3,
              aes (label =  glue("*{comma(total_suspensions, accuracy = 1) } suspensions for {comma(unduplicated_count_of_students_suspended_total, accuracy = 1) } students*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.2) +

  labs(title = ("Monterey County Repeat Suspensions By Racial Group"), # fn("K-12 Suspension Rates Over Time"),
       caption = "Source: Suspension 2019-20 Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp") +
  geom_textbox(x = 6.5, y = .8, fill = "lightgrey",
               label = "Latino students who had been suspended in 2019-20 were suspended one and a half times on average.")






```


## 

```{r susp-district}

susp_vroom %>%  
  filter( aggregate_level %in% c("C","D"),
    academic_year == max(academic_year),
    reporting_category == "RB",
    !is.na(suspension_rate_total)
 ) %>%
  left_join_codebook("SUSP","reporting_category") %>%
    rename(ReportingCategory = reporting_category) %>%
 mutate(cds = paste0(county_code,district_code,school_code)) %>%
    left_join(entit) %>%
    mutate(District = if_else(is.na(District),"Monterey County",District)) %>%

      lollipop(y_var = suspension_rate_total,
             x_var = District,
             colorme = "lightblue") +
                geom_richtext(size = 3,
              aes (label =  glue("*{comma(unduplicated_count_of_students_suspended_total, accuracy = 1) } of {comma(cumulative_enrollment, accuracy = 1) }*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.008) +


  labs(title = ("K-12 Suspension Rates By District for African-Americans"),         caption = "Source: Suspension 2019-20 Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp") +
  geom_textbox(x = 5, y = .1, fill = "lightgrey",
               label = "The rate of suspensions varies greatly across districts.  Since some districts have low numbers of African-Americans enrolled, a single suspension can represent a large percentage.")


```


## 

```{r susp-county}

susp_vroom %>%  
  filter( aggregate_level %in% c("C","D"),
    academic_year == max(academic_year),
    reporting_category == "RH",
    !is.na(suspension_rate_total)
 ) %>%
  left_join_codebook("SUSP","reporting_category") %>%
    rename(ReportingCategory = reporting_category) %>%
 mutate(cds = paste0(county_code,district_code,school_code)) %>%
    left_join(entit) %>%
    mutate(District = if_else(is.na(District),"Monterey County",District)) %>%


ggplot( aes( y = suspension_rate_total/100, x =fct_reorder(District, suspension_rate_total) ,  label = percent(suspension_rate_total/100, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder(District, suspension_rate_total), xend=fct_reorder(District, suspension_rate_total), y=0, yend=suspension_rate_total/100),
                color="lightgreen",
                size =2 ) +
  geom_point( color="lightgreen", size=5, alpha=0.6) +
#  facet_grid(facets = vars(StudentGroupCategory), scales = "free" ) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_hc() +
  mcoe_theme +
                geom_richtext(size = 3,
              aes (label =  glue("*{comma(unduplicated_count_of_students_suspended_total, accuracy = 1) } of {comma(cumulative_enrollment, accuracy = 1) }*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.07) +

  labs(title = ("K-12 Suspension Rates By District for Latinxs"), # fn("K-12 Suspension Rates Over Time"),
       caption = "Source: Suspension 2019-20 Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp") +
  geom_textbox(x = 9, y = .035, fill = "lightgrey",
               label = "The rate of suspensions varies greatly across districts. South Monterey County Joint Union has the highest rate of suspensions of Latinx students of any district.")


```


## 

```{r susp-swd}

susp_vroom %>%  
  filter( aggregate_level %in% c("C","D"),
    academic_year == max(academic_year),
    reporting_category == "SD",
    !is.na(suspension_rate_total)
 ) %>%
  left_join_codebook("SUSP","reporting_category") %>%
    rename(ReportingCategory = reporting_category) %>%
 mutate(cds = paste0(county_code,district_code,school_code)) %>%
    left_join(entit) %>%
    mutate(District = if_else(is.na(District),"Monterey County",District)) %>%

      lollipop(y_var = suspension_rate_total,
             x_var = District,
             colorme = "hotpink") +
                geom_richtext(size = 3,
              aes (label =  glue("*{comma(unduplicated_count_of_students_suspended_total, accuracy = 1) } of {comma(cumulative_enrollment, accuracy = 1) }*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.008) +


  labs(title = ("K-12 Suspension Rates By District for Students with Disabilities"),         caption = "Source: Suspension 2019-20 Data Files \n https://www.cde.ca.gov/ds/sd/sd/filessd.asp") +
  geom_textbox(x = 5, y = .06, fill = "lightgrey",
               label = "The rate of suspensions varies greatly across districts.  South Monterey County Joint Union has the highest rate of suspensions of students with disabilities of any district.")


```


## Demo notes 

- How do people report race/ethnicity
- Should I filter only to teachers ?  
- This is only public school data (includes charters but not private)
- Does not include ECE students 


## Suspension Notes

- Is this cumulative enrollment? YES 
- Single year presented


## Expulsions

```{r expulsions}


exp <- tbl(con,"EXP") %>% 
  filter(county_code == 27,
         academic_year == "2019-20",
          charter_yn == "All" | is.na(charter_yn) | charter_yn == ""
         ) %>%
  collect() %>%
  mutate(Geo = if_else(aggregate_level == "T", "California" ,county_name ))# %>%
#  mutate_at(vars(cumulative_enrollment:suspension_count_other_reasons), funs(as.numeric) )

exp_all <- exp %>%
  filter( (aggregate_level == "T"  |county_code == 27),
          reporting_category == "TA") 



exp_sub <- exp %>%  
  filter( is.na(district_code),
    (county_code == 27),
    academic_year == max(academic_year),
    !is.na(expulsion_rate_total),
    str_sub(reporting_category,1,1) == "R"
 ) %>%
  left_join_codebook("EXP","reporting_category") %>%
    rename(ReportingCategory = reporting_category) %>%
  mutate(exp.rate = 10000*total_expulsions/cumulative_enrollment ) 



ggplot(exp_sub, aes( y = exp.rate, x =fct_reorder(definition, exp.rate) ,  label = comma(exp.rate, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder(definition, exp.rate), xend=fct_reorder(definition, exp.rate), y=0, yend=exp.rate),
                color="orange",
                size =2 ) +
  geom_point( color="orange", size=5, alpha=0.6) +
#  facet_grid(facets = vars(StudentGroupCategory), scales = "free" ) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous() +
  theme_hc() +
  mcoe_theme +
              #   geom_richtext(size = 3,
              # aes (label = glue("*{comma(cumulative_enrollment, accuracy = 1) }*" ) ), 
              # fill = NA, label.color = NA,
              #      y = 0.002) +

  labs(title = ("Monterey County Expulsion Rates By Racial Group"),
       subtitle = "Expulsions per 10,000 students",
       caption = "Source: Expulsion 2019-20 Data Files \n https://www.cde.ca.gov/ds/ad/filesed.asp") +
  geom_textbox(x = 4, y = 5, fill = "lightgrey",
               label = "African-Americans are expelled at a higher rate than other racial groups, however, the African-American and White categories each represent only a single student each. There were 25 expulsions total in 2019-20.")


```


## AP courses

``` {r AP}

ap <- tbl(con,"AP") %>% 
    filter(
        year == "2019-20",
        cname == "Monterey"
        # Grade == "13",
        # County_Code == 27,
        # School_Code == "0000000",
        # Subgroup_ID == 1 | Subgroup_ID >70 & Subgroup_ID <81
    ) %>%
#    head(50) %>%
    collect()

ap.county <- ap %>%
  filter(rtype == "C") %>%
  filter(studentgroup %notin% c("EL","FOS","HOM", "SED", "SWD")) %>%
  left_join_codebook("AP","studentgroup") %>%
  mutate(perc.take = 100*numtsttakr/enroll1012,
         high.scorers = 100*(numscr4=numscr5)/numtsttakr)


ap.county %>%
      lollipop(y_var = perc.take,
             x_var = definition,
             colorme = "orange") +
      # geom_text(size = 3,
      #         aes (label = denom),
      #              y = 0.05) +
              #     geom_richtext(size = 3,
              # aes (label = glue("*{comma(denom, accuracy = 1) }*" ) ), 
              # fill = NA, label.color = NA,
              #      y = 0.05) +

    labs(title = "AP Test Takers Out of 10-12 Grade Enrollment" ,
         caption = "Source: Postsecondary Preparation Data Files for 2019-20\nhttps://www.cde.ca.gov/ds/sp/ai/") +
  geom_textbox(x = 3, y = .3, fill = "lightgrey",
               label = "Multiracial students are most likely to take an AP test, while African-American students are the least likely racial group.")



```

##

``` {r ap-high}


ap.county %>%
  filter(!is.na(high.scorers)) %>%
      lollipop(y_var = high.scorers,
             x_var = definition,
             colorme = "orange") +
      # geom_text(size = 3,
      #         aes (label = denom),
      #              y = 0.05) +
              #     geom_richtext(size = 3,
              # aes (label = glue("*{comma(denom, accuracy = 1) }*" ) ), 
              # fill = NA, label.color = NA,
              #      y = 0.05) +

    labs(title = "AP Test Takers who Score 4 or 5" ,
         caption = "Source: Postsecondary Preparation Data Files for 2019-20\nhttps://www.cde.ca.gov/ds/sp/ai/") +
  geom_textbox(x = 3, y = .26, fill = "lightgrey",
               label = "Of students who take an AP test, Multiracial students  are most likely to score a 4 or a 5.")



```

##


``` {r college-board}

ap.college.board <- tribble( ~"race", ~"students", ~"taken", ~"passed",
        "Asian",177, 361, 146,
        "Black",16, 24,4,
        "Hispanic or Latino",1845, 2974, 926,
        "Pacific Islander",6, 10, 0,
        "White",527, 1016, 601,
        "Two or more races",101, 182, 97,
        "No response",45, 72, 35
        ) %>%
  mutate(perc = 100*passed/taken,
         repeats = taken/students)


ap.college.board %>%
      lollipop(y_var = perc,
             x_var = race,
             colorme = "orange") +
      # geom_text(size = 3,
      #         aes (label = denom),
      #              y = 0.05) +
              #     geom_richtext(size = 3,
              # aes (label = glue("*{comma(denom, accuracy = 1) }*" ) ), 
              # fill = NA, label.color = NA,
              #      y = 0.05) +

    labs(title = "AP Tests Scoring 3, 4 or 5" ,
         caption = "Source: College Board Integrated Dashboard File 2021") +
  geom_textbox(x = 3, y = .26, fill = "lightgrey",
               label = "Of students who take an AP test, White students  are most likely to score a 3, 4 or a 5.")


```

##

``` {r college-repeat}


ap.college.board %>%
ggplot( aes( y = repeats, x =fct_reorder(race, repeats) ,  label = comma(repeats, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder(race, repeats), xend=fct_reorder(race, repeats), y=0, yend=repeats),
                color="orange",
                size =2 ) +
  geom_point( color="orange", size=5, alpha=0.6) +
#  facet_grid(facets = vars(StudentGroupCategory), scales = "free" ) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous() +
  theme_hc() +
  mcoe_theme +
              #   geom_richtext(size = 3,
              # aes (label = glue("*{comma(cumulative_enrollment, accuracy = 1) }*" ) ), 
              # fill = NA, label.color = NA,
              #      y = 0.002) +

    labs(title = "Number of AP tests taken per person" ,
         caption = "Source: College Board Integrated Dashboard File 2021") +
  geom_textbox(x = 3, y = .26, fill = "lightgrey",
               label = "Of students who take an AP test, White students are most likely to take multiple tests.")


```

## AP Notes

- College Board does not include total enrollments, so rates by racial group are not available 
- There are big drops in 2020 and even more substantial drops in 2021. 
- They use scores of 3,4 or 5 versus what I did of 4 or 5
- Exams taken by race are similar but don't match CDE numbers exactly
- SAT numbers dropped to almost none in 2021



## CAASPP ELA Testing

```{r math}

# Generated from the CAASPP repo

sbac.all <- tbl(con,"CAASPP") %>% 
    filter(
        Test_Year == "2019",
        Grade == "13",
        County_Code == 27,
        School_Code == "0000000",
        Subgroup_ID == 1 | Subgroup_ID >70 & Subgroup_ID <81
    ) %>% 
#    head(50) %>%
    collect()

codebook.caaspp <- sbac.all %>%
    mutate(Subgroup_ID = as.character(Subgroup_ID)) %>%
    left_join_codebook("CAASPP","Subgroup_ID") %>%
    mutate(Percentage_Standard_Met_and_Above = as.numeric(Percentage_Standard_Met_and_Above),
           cds = paste0(County_Code,District_Code,School_Code)) %>%
    left_join(entit) %>%
    mutate(District = if_else(is.na(District),"Monterey County",District))





caaspp_lollipop <- function(testy, district, students, df) {
    
    if (testy == 2) {test <- "Math"} else {test <- "ELA"}
    
   colorful <- case_when(district == FALSE ~ "orange",
          district == TRUE & students == 74 ~ "lightblue",
          district == TRUE & students == 78 ~ "lightgreen" )
    
    df %>%
        filter(Test_Id == testy) %>%
        filter(case_when(district == FALSE ~ District_Code == "00000",
                         district == TRUE ~ Subgroup_ID == students)) %>%
        filter(!is.na(Percentage_Standard_Met_and_Above)) %>%
    lollipop(y_var = Percentage_Standard_Met_and_Above,
             x_var = case_when(district == FALSE ~ definition,
                         district == TRUE ~ District),
             colorful) +
  labs(title = (paste0("Percentage Meeting and Exceeding Standards for ",test,   case_when(district == FALSE ~ " Countywide by Racial Group",
          district == TRUE & students == 74 ~ " by District for African-Americans",
          district == TRUE & students == 78 ~ " by District for Latinxs" )
                       )),
       caption = "Source: CAASPP 2019 Research Files \n https://caaspp-elpac.cde.ca.gov/caaspp/ResearchFileList")
    
}

caaspp_lollipop(df = codebook.caaspp,
                students = 74,
                testy = 1,
                district = FALSE
)  +
  geom_textbox(x = 3, y = .6, fill = "lightgrey",
               label = "There are large differences in the degree of success our county is having in preparing students of various racial groups to meet or exceed standards on standardized tests.")





```

##

```{r ela-black}

caaspp_lollipop(df = codebook.caaspp,
                students = 74,
                testy = 1,
                district = TRUE
) +
  geom_textbox(x = 2.75, y = .63, fill = "lightgrey",
               label = "There are large differences in the degree of success our county is having in preparing African-American students to meet or exceed standards on standardized ELA tests.  For example Pacific Grove and Soledad have more than double the rates of Salinas City and Monterey Peninsula.")



```


##

```{r ela-latinx}

caaspp_lollipop(df = codebook.caaspp,
                students = 78,
                testy = 1,
                district = TRUE
) +
  geom_textbox(x = 8, y = .55, fill = "lightgrey",
               label = "There are large differences in the degree of success our county is having in preparing Latinx students to meet or exceed standards on standardized ELA tests. For example Pacific Grove and Lagunita have more than double the rates of San Lucas and San Ardo.")



```


## CAASPP Math Testing

```{r math-county}

caaspp_lollipop(df = codebook.caaspp,
                students = 74,
                testy = 2,
                district = FALSE
) +
  geom_textbox(x = 3, y = .5, fill = "lightgrey",
               label = "There are large differences in the degree of success our county is having in preparing students of various racial groups to meet or exceed standards on standardized Math tests.")



```


##

```{r math-black}

caaspp_lollipop(df = codebook.caaspp,
                students = 74,
                testy = 2,
                district = TRUE
) +
  geom_textbox(x = 3, y = .4, fill = "lightgrey",
               label = "There are large differences in the degree of success our county is having in preparing African-American students to meet or exceed standards on standardized Math tests. For example Soledad and Alisal have more than double the rates of Monterey Peninsula and Salinas City.")



```


##

```{r math-latinx}

caaspp_lollipop(df = codebook.caaspp,
                students = 78,
                testy = 2,
                district = TRUE
) +
  geom_textbox(x = 7, y = .4, fill = "lightgrey",
               label = "There are large differences in the degree of success our county is having in preparing Latinx students to meet or exceed standards on standardized Math tests. For example Graves and Pacific Grove have more than five times the rates of San Lucas and San Ardo.")



```


## Graduates who are Prepared for College / Career  

```{r cci}


cci <- tbl(con, "DASH_CCI") %>%
    filter(rtype == "D",
           reportingyear == "2020",
           countyname == "Monterey") %>%
#    head() %>%
    collect() %>%
    filter( studentgroup %in% c("AA", "AI","ALL", "AS","HI", "FI", "MR","PI","WH")) %>%
    left_join_codebook("DASH_CCI","studentgroup")
            
cci_county <- cci %>%
    group_by(studentgroup) %>%
    summarise(denom = sum(currdenom, na.rm = TRUE), num = sum(curr_prep, na.rm = TRUE)) %>%
    mutate(perc = 100*num/denom) %>%
    left_join_codebook("DASH_CCI","studentgroup") 


cci_county %>%
    lollipop(y_var = perc,
             x_var = definition,
             colorme = "orange") +
      # geom_text(size = 3,
      #         aes (label = denom),
      #              y = 0.05) +
                  geom_richtext(size = 3,
              aes (label = glue("*{comma(num, accuracy = 1) } of {comma(denom, accuracy = 1) }*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.05) +

    labs(caption = "Source: CA Dashboard Additional Reports 2020 College-Career Data Files\nhttps://www.cde.ca.gov/ta/ac/cm/datafiles2020.asp") +
  geom_textbox(x = 3, y = .55, fill = "lightgrey",
               label = "The italicized number is the total number of students in the group, not only those who are prepared.  There are large differences in the degree of success our county is having in preparing students for college or careers with Pacific Islanders and American Indians having the lowest levels.")

```

## African American Graduates who are Prepared for College / Career by District 

```{r cci-black} 

cci %>%
    filter(studentgroup == "AA",
           !is.na(curr_prep_pct)) %>%
    lollipop(y_var = curr_prep_pct,
             x_var = districtname,
             colorme = "lightblue") +
                  geom_richtext(size = 3,
              aes (label = glue(" *{comma(curr_prep, accuracy = 1)}* *of* *{comma(currdenom, accuracy = 1) }*" ) ),
              fill = NA, label.color = NA,
                   y = 0.05) +
    labs(caption = "Source: CA Dashboard Additional Reports 2020 College-Career Data Files\nhttps://www.cde.ca.gov/ta/ac/cm/datafiles2020.asp") +
  geom_textbox(x = 1.5, y = .5, fill = "lightgrey",
               label = "Salinas Union has higher rates of preparing African- American students for college or careers than Monterey Peninsula.")


```

## Latinx Graduates who are Prepared for College / Career by District 

```{r cci-latinx}            
cci %>%
    filter(studentgroup == "HI",
           !is.na(curr_prep_pct)) %>%
    lollipop(y_var = curr_prep_pct,
             x_var = districtname,
             colorme = "lightgreen") +
                  geom_richtext(size = 3,
              aes (label = glue(" *{comma(curr_prep, accuracy = 1)}* *of* *{comma(currdenom, accuracy = 1) }*" ) ),
              fill = NA, label.color = NA,
                   y = 0.2) +
    labs(caption = "Source: CA Dashboard Additional Reports 2020 College-Career Data Files\nhttps://www.cde.ca.gov/ta/ac/cm/datafiles2020.asp") +
  geom_textbox(x = 3, y = .55, fill = "lightgrey",
               label = "There are large differences in the degree of success our county is having in preparing Latinx students for college or careers.  For example, Pacific Grove and Carmel are much higher than Salinas Union or Monterey County Office of Education.")


```


## College Going Rate - Countywide by Racial Group


```{r cgr}


cgr_all <- tbl(con, "CGR")  %>%
  filter( # AggregateLevel %in% c("T", "C"),
          CountyCode %in% c("27"), 
#          CountyCode %in% c("27","00"), 
#          ReportingCategory == "TA",
          CharterSchool =="All",
          AlternativeSchoolAccountabilityStatus == "All",
          CompleterType =="TA"
) %>%
  collect() %>%
  mutate(Geo = if_else(AggregateLevel == "T", "California" , CountyName)) %>%
  mutate(CGR12 = College_Going_Rate_Total_12_Months,
         CGR12 = as.numeric(CGR12),
         DistrictName = if_else(is.na(DistrictName),"Monterey County",DistrictName)) %>%
    filter(ReportingCategory == "TA" | str_sub(ReportingCategory,1,1) == "R" ) %>%
    left_join_codebook("CGR","ReportingCategory") 

cgr_all %>% 
    filter(AcademicYear == max(AcademicYear),
           AggregateLevel %in% c("T", "C")) %>%
lollipop(
         y_var = CGR12,
         x_var = definition,
         colorme = "orange") +
          # geom_text(size = 3,
          #     aes (label = High_School_Completers),
          #          y = 0.05) +
                    geom_richtext(size = 3,
              aes (label = glue("*{comma(Enrolled_In_College_Total_12_Months, accuracy = 1) } out of {comma(High_School_Completers, accuracy = 1) }*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.05) +

  labs(#title = ("College-Going Rate"),
       caption = "Source: College-Going Rate for 2017-18 HS Completers (12-month) \n  https://www.cde.ca.gov/ds/ad/pse.asp") +
  geom_textbox(x = 3, y = .7, fill = "lightgrey",
               label = "Asian students are much more likely than Pacific Islander students to go to college.")




```



## College Going Rate - By District


```{r cgr-black}

cgr_all %>% 
    filter(AcademicYear == max(AcademicYear),
           AggregateLevel %in% c("C", "D"),
           ReportingCategory == "RB",
           !is.na(CGR12)) %>%
lollipop(
         y_var = CGR12,
         x_var = DistrictName,
         colorme = "lightblue") +
            # geom_text(size = 3,
            #   aes (label = High_School_Completers),
            #        y = 0.05) +
                      geom_richtext(size = 3,
              aes (label = glue("*{comma(Enrolled_In_College_Total_12_Months, accuracy = 1) } out of {comma(High_School_Completers, accuracy = 1) }*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.05) +

  labs(title = ("College-Going Rate by District for African-Americans "),
       caption = "Source: College-Going Rate for 2017-18 HS Completers (12-month) \n  https://www.cde.ca.gov/ds/ad/pse.asp") +
  geom_textbox(x = 2.5, y = .4, fill = "lightgrey",
               label = "Monterey Peninsula has higher rates of African-American students going to college than Salinas Union.")


```


## College Going Rate - By District


```{r cgr-latinx}

cgr_all %>% 
    filter(AcademicYear == max(AcademicYear),
           AggregateLevel %in% c("C", "D"),
           ReportingCategory == "RH",
           !is.na(CGR12)) %>%
lollipop(
         y_var = CGR12,
         x_var = DistrictName,
         colorme = "lightgreen") +
            # geom_text(size = 3,
            #   aes (label = High_School_Completers),
            #        y = 0.05) +
                        geom_richtext(size = 3,
              aes (label = glue("*{comma(Enrolled_In_College_Total_12_Months, accuracy = 1) } out of {comma(High_School_Completers, accuracy = 1) }*" ) ), 
              fill = NA, label.color = NA,
                   y = 0.05) +
  labs(title = ("College-Going Rate by District for Latinxs "),
       caption = "Source: College-Going Rate for 2017-18 HS Completers (12-month) \n  https://www.cde.ca.gov/ds/ad/pse.asp") +
  geom_textbox(x = 2, y = .66, fill = "lightgrey",
               label = "There are large differences in the rate at which Latinx students go to college. For example, Carmel and Gonzales have much higher rates than Monterey County Office of Education and North Monterey County.")


```

``` {r tableua, include = FALSE} 
## Interaction College Data

# https://public.tableau.com/app/profile/tulare.county.office.of.education/viz/CaliforniaPostsecondaryDataExplorer/Menu

```

## Special Populations

```{r homeless}

homeless <- tbl(con, "UPC") %>%
  filter(county_name == "Monterey",
         academic_year == "2020-2021") %>%
 # head() %>%
  collect()
  

homeless.sum <- homeless %>%
  group_by(district_name) %>%
  transmute(homeless.tot = sum(homeless),
            foster.tot = sum(foster),
            migrant.tot = sum(migrant_program),
            tot.tot = sum(total_enrollment),
            homeless.perc = 100*homeless.tot/tot.tot,
            foster.perc = 1000*foster.tot/tot.tot,
            migrant.perc = 100*migrant.tot/tot.tot) %>%
  distinct(  )



homeless.sum %>%
lollipop(
         y_var = homeless.perc,
         x_var = district_name,
         colorme = "orange") +

  labs(title = ("Percent of Reported Homeless Students by District"),
       caption = "Source: CALPADS Unduplicated Pupil Count for 2020-21\n  https://www.cde.ca.gov/ds/ad/filescupc.asp") +
  geom_textbox(x = 9, y = .25, fill = "lightgrey",
               label = "The rates of homelessness and how different districts interpret McKinney-Vento laws varies greatly.  This results in reported rates ranging from no homeless students to more than a third of students being reported as homeless.")



```


##

``` {r foster}


homeless.sum %>%
# lollipop(
#          y_var = foster.perc,
#          x_var = district_name,
#          colorme = "orange") +

  ggplot( aes( y = foster.perc, x =fct_reorder(district_name, foster.perc) ,  label = comma(foster.perc, accuracy = .1))) +
  geom_segment( aes(x=fct_reorder(district_name, foster.perc), xend=fct_reorder(district_name, foster.perc), y=0, yend=foster.perc),
                color="orange",
                size =2 ) +
  geom_point( color="orange", size=5, alpha=0.6) +
#  facet_grid(facets = vars(StudentGroupCategory), scales = "free" ) +
  coord_flip() +
  geom_text(size = 3, color = "black") +
  scale_y_continuous() +
  theme_hc() +
  mcoe_theme +

  
  labs(title = ("Reported Foster Students per Thousand by District"),
       caption = "Source: CALPADS Unduplicated Pupil Count for 2020-21\n  https://www.cde.ca.gov/ds/ad/filescupc.asp") +
  geom_textbox(x = 9, y = 7.5, fill = "lightgrey",
               label = "Foster students represents less than half a percent of students in all but one districts. Foster youth often need additional support in navigating school success.")




```


##

``` {r migrant}


homeless.sum %>%
lollipop(
         y_var = migrant.perc,
         x_var = district_name,
         colorme = "orange") +

  labs(title = ("Percent of Migrant Students by District"),
       caption = "Source: CALPADS Unduplicated Pupil Count for 2020-21\n  https://www.cde.ca.gov/ds/ad/filescupc.asp") +
  geom_textbox(x = 10, y = .1, fill = "lightgrey",
               label = "Migrant students are in about half of Montery County districts.")




```


##

``` {r homeless-race}

homeless.race <- data.frame(
                  stringsAsFactors = FALSE,
                  African.American = c(1.0),
  American.Indian.or.Alaska.Native = c(0.3),
                             Asian = c(0.7),
                          Filipino = c(1.0),
                Hispanic.or.Latino = c(92.3),
                  Pacific.Islander = c(0.4),
                             White = c(3.1),
                 Two.or.More.Races = c(0.7),
                      Not.Reported = c(0.4)
) %>% t() %>% 
  as.data.frame() %>%
  rownames_to_column("race") %>%
  rename(perc = V1) 

homeless.race %>%
lollipop(
         y_var = perc,
         x_var = race,
         colorme = "orange") +

  labs(title = ("Percent of Reported Homeless Students by Race"),
       caption = "Source: Dataquest export for 2020-21\n  https://data1.cde.ca.gov/dataquest/dqcensus/EnrEthLevels.aspx?cds=27&agglevel=county&year=2020-21") +
  geom_textbox(x = 6, y = .5, fill = "lightgrey",
               label = "The large majority of reported homeless students are Hispanic or Latino.")



```


##

``` {r foster-race}

foster.race <- 
  
  data.frame(
                  stringsAsFactors = FALSE,
                  African.American = c(4.2),
  American.Indian.or.Alaska.Native = c(0.7),
                             Asian = c(0.0),
                          Filipino = c(0.7),
                Hispanic.or.Latino = c(77.1),
                  Pacific.Islander = c(0.0),
                             White = c(13.2),
                 Two.or.More.Races = c(0.7),
                      Not.Reported = c(3.5)
  )  %>% 
  t() %>% 
  as.data.frame() %>%
  rownames_to_column("race") %>%
  rename(perc = V1) 

foster.race %>%
lollipop(
         y_var = perc,
         x_var = race,
         colorme = "orange") +

  labs(title = ("Percent of Reported Foster Students by Race"),
       caption = "Source: Dataquest export for 2020-21\n  https://data1.cde.ca.gov/dataquest/dqcensus/EnrEthLevels.aspx?cds=27&agglevel=county&year=2020-21") +
  geom_textbox(x = 6, y = .5, fill = "lightgrey",
               label = "The  majority of reported foster students are Hispanic or Latino.")



```


``` {r notes, include = FALSE}
# 
# ## MCOE Efforts
# 
# - African-American Leadership Council
# - ALL IN for Equity
# - National Equity Project
# - etc. 
# 
# 
# ##  Transfers to Alternative Programs
# 
# - I don't know how to find this information? 
# - Demographics of alternative schools and compared to overall is included above  
# 
# ## College Board
# 
# - I emailed and they said they would discuss internally and get back to me. 
# - They have not yet. 
# 
# ## Migrant Ed
# 
# - I emailed Constantino.  
# - I received an auto-reply message saying he was out of the office. 

```
